/*
 * Copyright (c) 2016 Motorola Mobility, LLC.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 * 1. Redistributions of source code must retain the above copyright notice,
 * this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation
 * and/or other materials provided with the distribution.
 * 3. Neither the name of the copyright holder nor the names of its
 * contributors may be used to endorse or promote products derived from this
 * software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#define DEBUG
#define DEBUG_DUMP_REGISTER

#include <nuttx/config.h>

#include <errno.h>
#include <debug.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <nuttx/device_cam_ext.h>
#include <nuttx/gpio.h>
#include <nuttx/device.h>
#include <nuttx/mhb/mhb_protocol.h>
#include <nuttx/mhb/mhb_csi_camera.h>
#include <nuttx/camera/camera_ext_defs.h>
#include <nuttx/device_mhb_cam.h>
#include <nuttx/math.h>
#include <nuttx/camera/camera_ext_meta.h>
#include <nuttx/camera/camera_ext.h>

struct dev_private_s
{
    uint8_t rst_n;
    uint8_t dvdd_en;
    uint8_t areg_en;
    uint8_t spi_sel;
};

struct dev_private_s s_data;

#define CAMERA_POWER_DELAY_US (100000)
#define CAMERA_SENSOR_I2C_ADDR 0x10

/*
 * This is the MHB(Mods Hi-Speed Bus) camera driver for
 * Sony IMS220 raw sensor
 *
 */

#define ARRAY_SIZE(x) (sizeof(x) / sizeof((x)[0]))

struct cam_i2c_reg_array {
    const uint16_t reg_addr;
    const uint8_t data;
};

struct cam_i2c_reg_setting {
    const uint16_t size;
    struct cam_i2c_reg_array const *regs;
};

static const struct cam_i2c_reg_array init_reg_array[] = {
    { 0x0103, 0x01 },
    /* External Clock Setting - 19.2 */
    { 0x011E, 0x13 },
    { 0x011F, 0x02 },
    /* Global Setting */
    { 0x0101, 0x03 },
    { 0x0220, 0x01 },
    { 0x9301, 0x01 },
    { 0x9278, 0x19 },
    { 0x93B4, 0x07 },
    { 0x93B5, 0x07 },
    { 0x9412, 0x29 },
    { 0x941B, 0x1B },
    { 0x941F, 0x86 },
    { 0x9431, 0x03 },
    { 0x943E, 0x05 },
    { 0x9507, 0x1B },
    { 0x950B, 0x1B },
    { 0x950F, 0x1B },
    { 0x960F, 0xCA },
    { 0x9631, 0x00 },
    { 0x9633, 0x40 },
    /* Defect Correction Recommended Setting */
    { 0x3434, 0x01 },
    { 0x3436, 0x01 },
    { 0x344A, 0x28 },
    { 0x344B, 0x14 },
    { 0x344E, 0x14 },
    { 0x3529, 0x00 },
    { 0x352A, 0x00 },
    { 0x352B, 0x00 },
    { 0x352C, 0x00 },
    { 0x352D, 0x00 },
    { 0x352E, 0x00 },
    { 0x352F, 0x00 },
    { 0x3530, 0x00 },
    { 0x3531, 0x00 },
    { 0x3532, 0x00 },
    { 0x3533, 0x00 },
    { 0x3534, 0x00 },
    { 0x3535, 0x00 },
    { 0x3536, 0x00 },
    { 0x3537, 0x00 },
    { 0x3538, 0x00 },
    { 0x3539, 0x00 },
    { 0x353A, 0x00 },
    { 0x353B, 0x00 },
    { 0x353C, 0x00 },
    { 0x353D, 0x00 },
    { 0x353E, 0x00 },
    { 0x353F, 0x00 },
    { 0x3540, 0x00 },
    { 0x3B0C, 0x00 },
    { 0x3B0D, 0x40 },
    { 0x3C54, 0x00 },
    { 0x3C55, 0x02 },
    { 0x3C56, 0x00 },
    { 0x3C57, 0x02 },
    { 0x3C58, 0x00 },
    { 0x3C59, 0x02 },
    { 0x3D0F, 0x40 },
    { 0x3D10, 0x40 },
    { 0x3D11, 0x40 },
    { 0x3F01, 0xC8 },
    { 0x3F03, 0x64 },
    { 0x3F05, 0x32 },
    { 0x3F07, 0xC8 },
    { 0x3F09, 0x64 },
    { 0x3F0B, 0x32 },
    /* LNR Parameter Setting */
    { 0x3523, 0x00 },
    { 0x3524, 0x00 },
    { 0x3525, 0x00 },
    { 0x3526, 0x00 },
    { 0x3527, 0x00 },
    { 0x3528, 0x00 },
    { 0x3E01, 0x00 },
    { 0x3E03, 0x00 },
    { 0x3E06, 0x14 },
    { 0x3E07, 0x14 },
    { 0x3E08, 0x14 },
    { 0x3E0B, 0x00 },
    { 0x3E0D, 0x00 },
    { 0x3E10, 0x14 },
    { 0x3E11, 0x14 },
    { 0x3E12, 0x14 },
    { 0x3E15, 0x00 },
    { 0x3E17, 0x00 },
    { 0x3E1A, 0x14 },
    { 0x3E1B, 0x14 },
    { 0x3E1C, 0x14 },
    { 0x3E1D, 0x02 },
    { 0x3E1E, 0x02 },
    { 0x3E20, 0x00 },
    { 0x3E21, 0x00 },
    { 0x3E23, 0x02 },
    { 0x3E24, 0x02 },
    { 0x3E26, 0x00 },
    { 0x3E27, 0x00 },
    { 0x3E29, 0x02 },
    { 0x3E2A, 0x02 },
    { 0x3E2C, 0x00 },
    { 0x3E2D, 0x00 },
    { 0x3E2F, 0x4C },
    { 0x3E30, 0x4C },
    /* HDR Setting */
    { 0x3201, 0xA8 },
    { 0x3202, 0x03 },
    { 0x3203, 0x84 },
    { 0x3217, 0x20 },
    { 0x321A, 0x03 },
    { 0x321B, 0x20 },
    { 0x3308, 0x06 },
    { 0x3400, 0x02 },
    { 0x3420, 0x80 },
    { 0x3421, 0x40 },
    { 0x3422, 0x20 },
    { 0x3429, 0x00 },
    { 0x342A, 0xEC },
    { 0x342B, 0xD8 },
    { 0x3500, 0x00 },
    { 0x3501, 0x00 },
    { 0x3502, 0x00 },
    { 0x3503, 0x00 },
    { 0x3504, 0x00 },
    { 0x3505, 0x01 },
    { 0x3544, 0x00 },
    { 0x3545, 0x00 },
    { 0x3546, 0x00 },
    { 0x3547, 0x00 },
    { 0x3548, 0x00 },
    { 0x3549, 0x00 },
    { 0x354A, 0x00 },
    { 0x3600, 0x02 },
    { 0x3601, 0x00 },
    { 0x3602, 0x02 },
    { 0x3603, 0x00 },
    { 0x3604, 0x02 },
    { 0x3605, 0x00 },
    { 0x360C, 0x00 },
    { 0x360D, 0x64 },
    { 0x360E, 0x00 },
    { 0x360F, 0x64 },
    { 0x3610, 0x00 },
    { 0x3611, 0x64 },
    { 0xAA1E, 0x00 },
    { 0xAA1F, 0x08 },
    { 0xAA53, 0x01 },
    { 0xAA70, 0x03 },
    { 0xAA71, 0xFF },
    { 0xAA72, 0x03 },
    { 0xAA73, 0xFF },
    { 0xAE45, 0x25 },
    { 0xAE47, 0x90 },
    { 0xAE51, 0x00 },
    { 0xAE5B, 0x00 },
    /* LSC setting */
    { 0x3801, 0x78 },
    { 0x3803, 0x78 },
    { 0x3805, 0x78 },
    { 0x3809, 0x3C },
    { 0x380B, 0x3C },
    { 0x380D, 0x78 },
    { 0x380F, 0x78 },
    { 0x3811, 0x78 },
    { 0x3815, 0x3C },
    { 0x3817, 0x3C },
    { 0x3819, 0x78 },
    { 0x381B, 0x78 },
    { 0x381D, 0x78 },
    { 0x3821, 0x3C },
    { 0x3823, 0x3C },
    { 0xAC3E, 0x70 },
};

static const struct cam_i2c_reg_array res_2624x1968_24fps_arrray[] = {
    /* V1/2 (4:3) 2624x1968 24fps  */
    /* Clock Setting */
    { 0x0301, 0x08 },
    { 0x0303, 0x01 },
    { 0x0304, 0x02 },
    { 0x0305, 0x08 },
    { 0x0306, 0x00 },
    { 0x0307, 0x31 },
    { 0x0309, 0x0A },
    { 0x030B, 0x01 },
    { 0x030C, 0x00 },
    { 0x030D, 0x7B },
    /* Size setting */
    { 0x0340, 0x07 },
    { 0x0341, 0xE0 },
    { 0x0342, 0x17 },
    { 0x0343, 0x10 },
    { 0x0344, 0x00 },
    { 0x0345, 0x00 },
    { 0x0346, 0x00 },
    { 0x0347, 0x00 },
    { 0x0348, 0x14 },
    { 0x0349, 0x7F },
    { 0x034A, 0x0F },
    { 0x034B, 0x5F },
    { 0x034C, 0x0A },
    { 0x034D, 0x40 },
    { 0x034E, 0x07 },
    { 0x034F, 0xB0 },
    { 0x0350, 0x00 },
    { 0x0351, 0x00 },
    { 0x0352, 0x00 },
    { 0x0353, 0x00 },
    { 0x0354, 0x0A },
    { 0x0355, 0x40 },
    { 0x0356, 0x07 },
    { 0x0357, 0xB0 },
    { 0x901D, 0x08 },
    /* Mode Setting */
    { 0x0108, 0x03 },
    { 0x0112, 0x0A },
    { 0x0113, 0x0A },
    { 0x0381, 0x01 },
    { 0x0383, 0x01 },
    { 0x0385, 0x01 },
    { 0x0387, 0x01 },
    { 0x0390, 0x01 },
    { 0x0391, 0x22 },
    { 0x0392, 0x00 },
    { 0x1307, 0x02 },
    { 0x9512, 0x40 },
    { 0xAB07, 0x01 },
    { 0xB802, 0x01 },
    { 0xB933, 0x00 },
    { 0x0700, 0x00 },
    { 0x13C0, 0x00 },
    { 0x13C1, 0x01 },
    { 0x9909, 0x01 },
    { 0x991E, 0x01 },
    { 0xBA03, 0x00 },
    { 0xBA07, 0x00 },
    /* Global Timing Setting */
    { 0x0830, 0x00 },
    { 0x0831, 0x57 },
    { 0x0832, 0x00 },
    { 0x0833, 0x1F },
    { 0x0834, 0x00 },
    { 0x0835, 0x37 },
    { 0x0836, 0x00 },
    { 0x0837, 0x1F },
    { 0x0838, 0x00 },
    { 0x0839, 0x17 },
    { 0x083A, 0x00 },
    { 0x083B, 0x17 },
    { 0x083C, 0x00 },
    { 0x083D, 0x77 },
    { 0x083E, 0x00 },
    { 0x083F, 0x17 },
    { 0x0842, 0x00 },
    { 0x0843, 0x0F },
    { 0x0844, 0x00 },
    { 0x0845, 0x37 },
    { 0x0847, 0x02 },
    /* Integration Time Setting */
    { 0x0202, 0x07 },
    { 0x0203, 0xD8 },
    /* Gain Setting */
    { 0x0205, 0x00 },
    { 0x020E, 0x01 },
    { 0x020F, 0x00 },
    { 0x0210, 0x01 },
    { 0x0211, 0x00 },
    { 0x0212, 0x01 },
    { 0x0213, 0x00 },
    { 0x0214, 0x01 },
    { 0x0215, 0x00 },
    /* HDR Setting */
    { 0x0233, 0x00 },
    { 0x0234, 0x00 },
    { 0x0235, 0x40 },
    { 0x0238, 0x01 },
    { 0x0239, 0x08 },
    { 0x13C2, 0x00 },
    { 0x13C3, 0x00 },
    { 0x13C4, 0x00 },
    { 0xAD34, 0x14 },
    { 0xAD35, 0x7F },
    { 0xAD36, 0x00 },
    { 0xAD37, 0x00 },
    { 0xAD38, 0x0F },
    { 0xAD39, 0x5D },
    { 0xAD3A, 0x00 },
    { 0xAD3B, 0x00 },
    { 0xAD3C, 0x14 },
    { 0xAD3D, 0x7F },
    { 0xAD3E, 0x0F },
    { 0xAD3F, 0x5D },
    /* Bypass Setting */
    { 0xA303, 0x00 },
    { 0xA403, 0x00 },
    { 0xA602, 0x00 },
    { 0xA703, 0x01 },
    { 0xA903, 0x01 },
    { 0xA956, 0x01 },
    { 0xAA03, 0x01 },
    { 0xAB03, 0x00 },
    { 0xAC03, 0x01 },
    { 0xAD03, 0x01 },
    { 0xAE03, 0x01 },
    { 0xB803, 0x01 },
    { 0xB903, 0x01 },
    { 0xB91A, 0x01 },
    { 0xBB03, 0x00 },
    /* Single Correct setting */
    { 0x4003, 0x00 },
    { 0x4004, 0x00 },
    { 0x4005, 0x00 },
    { 0x4006, 0x80 },
    { 0x4007, 0x80 },
    { 0x4008, 0x80 },
    { 0x400C, 0x00 },
    { 0x400D, 0x00 },
    { 0x400E, 0x00 },
    { 0x400F, 0x80 },
    { 0x4010, 0x80 },
    { 0x4011, 0x80 },
    /* Mode etc setting */
    { 0x3008, 0x01 },
    { 0x3009, 0x51 },
    { 0x300A, 0x51 },
    { 0x3506, 0x00 },
    { 0x3507, 0x01 },
    { 0x3508, 0x00 },
    { 0x3509, 0x01 },
    { 0xA913, 0x00 },
    { 0xAC13, 0x00 },
    { 0xAC3F, 0x00 },
    { 0xAE8B, 0x36 },
    { 0xB812, 0x00 },
    /* LNR setting */
    { 0x3516, 0x00 },
    { 0x3517, 0x00 },
    { 0x3518, 0x00 },
    { 0x3519, 0x00 },
    { 0x351A, 0x00 },
    { 0x351B, 0x00 },
    { 0x351C, 0x00 },
    { 0x351D, 0x00 },
    { 0x351E, 0x00 },
    { 0x351F, 0x00 },
    { 0x3520, 0x00 },
    { 0x3521, 0x00 },
    { 0x3522, 0x00 },
};

static const struct cam_i2c_reg_array res_5248x3936_12fps_array[] = {
    /* Full size 5248x3936 (4:3) 12fps */
    /* Clock Setting */
    { 0x0301, 0x08 },
    { 0x0303, 0x01 },
    { 0x0304, 0x02 },
    { 0x0305, 0x08 },
    { 0x0306, 0x00 },
    { 0x0307, 0x31 },
    { 0x0309, 0x0A },
    { 0x030B, 0x01 },
    { 0x030C, 0x00 },
    { 0x030D, 0xE8 },
    /* Size setting */
    { 0x0340, 0x0F },
    { 0x0341, 0x90 },
    { 0x0342, 0x1b },
    { 0x0343, 0x58 },
    { 0x0344, 0x00 },
    { 0x0345, 0x00 },
    { 0x0346, 0x00 },
    { 0x0347, 0x00 },
    { 0x0348, 0x14 },
    { 0x0349, 0x7F },
    { 0x034A, 0x0F },
    { 0x034B, 0x5F },
    { 0x034C, 0x14 },
    { 0x034D, 0x80 },
    { 0x034E, 0x0F },
    { 0x034F, 0x60 },
    { 0x0350, 0x00 },
    { 0x0351, 0x00 },
    { 0x0352, 0x00 },
    { 0x0353, 0x00 },
    { 0x0354, 0x14 },
    { 0x0355, 0x80 },
    { 0x0356, 0x0F },
    { 0x0357, 0x60 },
    { 0x901D, 0x08 },
    /* Mode Setting */
    { 0x0108, 0x03 },
    { 0x0112, 0x0A },
    { 0x0113, 0x0A },
    { 0x0381, 0x01 },
    { 0x0383, 0x01 },
    { 0x0385, 0x01 },
    { 0x0387, 0x01 },
    { 0x0390, 0x00 },
    { 0x0391, 0x11 },
    { 0x0392, 0x00 },
    { 0x1307, 0x00 },
    { 0x9512, 0x40 },
    { 0xAB07, 0x01 },
    { 0xB802, 0x01 },
    { 0xB933, 0x00 },
    /* OptionnalFunction setting */
    { 0x0700, 0x00 },
    { 0x13C0, 0x01 },
    { 0x13C1, 0x02 },
    { 0x9909, 0x01 },
    { 0x991E, 0x01 },
    { 0xBA03, 0x00 },
    { 0xBA07, 0x00 },
    /* Global Timing Setting */
    { 0x0830, 0x00 },
    { 0x0831, 0x6F },
    { 0x0832, 0x00 },
    { 0x0833, 0x2F },
    { 0x0834, 0x00 },
    { 0x0835, 0x57 },
    { 0x0836, 0x00 },
    { 0x0837, 0x2F },
    { 0x0838, 0x00 },
    { 0x0839, 0x2F },
    { 0x083A, 0x00 },
    { 0x083B, 0x2F },
    { 0x083C, 0x00 },
    { 0x083D, 0xBF },
    { 0x083E, 0x00 },
    { 0x083F, 0x27 },
    { 0x0842, 0x00 },
    { 0x0843, 0x0F },
    { 0x0844, 0x00 },
    { 0x0845, 0x37 },
    { 0x0847, 0x02 },
    /* Integration Time Setting */
    { 0x0202, 0x0F },
    { 0x0203, 0x88 },
    /* Gain Setting */
    { 0x0205, 0x00 },
    { 0x020E, 0x01 },
    { 0x020F, 0x00 },
    { 0x0210, 0x01 },
    { 0x0211, 0x00 },
    { 0x0212, 0x01 },
    { 0x0213, 0x00 },
    { 0x0214, 0x01 },
    { 0x0215, 0x00 },
    /* HDR Setting */
    { 0x0233, 0x00 },
    { 0x0234, 0x00 },
    { 0x0235, 0x40 },
    { 0x0238, 0x01 },
    { 0x0239, 0x08 },
    { 0x13C2, 0x00 },
    { 0x13C3, 0x00 },
    { 0x13C4, 0x00 },
    { 0xAD34, 0x14 },
    { 0xAD35, 0x7F },
    { 0xAD36, 0x00 },
    { 0xAD37, 0x00 },
    { 0xAD38, 0x0F },
    { 0xAD39, 0x5D },
    { 0xAD3A, 0x00 },
    { 0xAD3B, 0x00 },
    { 0xAD3C, 0x14 },
    { 0xAD3D, 0x7F },
    { 0xAD3E, 0x0F },
    { 0xAD3F, 0x5D },
    /* Bypass Setting */
    { 0xA303, 0x00 },
    { 0xA403, 0x00 },
    { 0xA602, 0x00 },
    { 0xA703, 0x01 },
    { 0xA903, 0x01 },
    { 0xA956, 0x01 },
    { 0xAA03, 0x01 },
    { 0xAB03, 0x01 },
    { 0xAC03, 0x01 },
    { 0xAD03, 0x01 },
    { 0xAE03, 0x01 },
    { 0xB803, 0x01 },
    { 0xB903, 0x01 },
    { 0xB91A, 0x01 },
    { 0xBB03, 0x00 },
    /* Single Correct setting */
    { 0x4003, 0x00 },
    { 0x4004, 0x00 },
    { 0x4005, 0x00 },
    { 0x4006, 0x80 },
    { 0x4007, 0x80 },
    { 0x4008, 0x80 },
    { 0x400C, 0x00 },
    { 0x400D, 0x00 },
    { 0x400E, 0x00 },
    { 0x400F, 0x80 },
    { 0x4010, 0x80 },
    { 0x4011, 0x80 },
    /* Mode etc setting */
    { 0x3008, 0x01 },
    { 0x3009, 0x51 },
    { 0x300A, 0x51 },
    { 0x3506, 0x00 },
    { 0x3507, 0x01 },
    { 0x3508, 0x00 },
    { 0x3509, 0x01 },
    { 0xA913, 0x00 },
    { 0xAC13, 0x00 },
    { 0xAC3F, 0x00 },
    { 0xAE8B, 0x36 },
    { 0xB812, 0x00 },
    /* LNR setting */
    { 0x3516, 0x00 },
    { 0x3517, 0x00 },
    { 0x3518, 0x00 },
    { 0x3519, 0x00 },
    { 0x351A, 0x00 },
    { 0x351B, 0x00 },
    { 0x351C, 0x00 },
    { 0x351D, 0x00 },
    { 0x351E, 0x00 },
    { 0x351F, 0x00 },
    { 0x3520, 0x00 },
    { 0x3521, 0x00 },
    { 0x3522, 0x00 },
};

static const struct cam_i2c_reg_array res_2624x1476_30fps_array[] = {
    /* V1/2 2624x1476 (16:9) 30fps  */
    /* Clock Setting */
    { 0x0301, 0x08 },
    { 0x0303, 0x01 },
    { 0x0304, 0x02 },
    { 0x0305, 0x08 },
    { 0x0306, 0x00 },
    { 0x0307, 0x31 },
    { 0x0309, 0x0A },
    { 0x030B, 0x01 },
    { 0x030C, 0x00 },
    { 0x030D, 0x7B },
    /* Size setting */
    { 0x0340, 0x06 },
    { 0x0341, 0x60 },
    { 0x0342, 0x17 },
    { 0x0343, 0x10 },
    { 0x0344, 0x00 },
    { 0x0345, 0x00 },
    { 0x0346, 0x01 },
    { 0x0347, 0xEC },
    { 0x0348, 0x14 },
    { 0x0349, 0x7F },
    { 0x034A, 0x0D },
    { 0x034B, 0x73 },
    { 0x034C, 0x0A },
    { 0x034D, 0x40 },
    { 0x034E, 0x05 },
    { 0x034F, 0xC4 },
    { 0x0350, 0x00 },
    { 0x0351, 0x00 },
    { 0x0352, 0x00 },
    { 0x0353, 0x00 },
    { 0x0354, 0x0A },
    { 0x0355, 0x40 },
    { 0x0356, 0x05 },
    { 0x0357, 0xC4 },
    { 0x901D, 0x08 },
    /* Mode Setting */
    { 0x0108, 0x03 },
    { 0x0112, 0x0A },
    { 0x0113, 0x0A },
    { 0x0381, 0x01 },
    { 0x0383, 0x01 },
    { 0x0385, 0x01 },
    { 0x0387, 0x01 },
    { 0x0390, 0x01 },
    { 0x0391, 0x22 },
    { 0x0392, 0x00 },
    { 0x1307, 0x02 },
    { 0x9512, 0x40 },
    { 0xAB07, 0x01 },
    { 0xB802, 0x01 },
    { 0xB933, 0x00 },
    /* OptionnalFunction setting */
    { 0x0700, 0x00 },
    { 0x13C0, 0x00 },
    { 0x13C1, 0x01 },
    { 0x9909, 0x01 },
    { 0x991E, 0x01 },
    { 0xBA03, 0x00 },
    { 0xBA07, 0x00 },
    /* Global Timing Setting */
    { 0x0830, 0x00 },
    { 0x0831, 0x57 },
    { 0x0832, 0x00 },
    { 0x0833, 0x1F },
    { 0x0834, 0x00 },
    { 0x0835, 0x37 },
    { 0x0836, 0x00 },
    { 0x0837, 0x1F },
    { 0x0838, 0x00 },
    { 0x0839, 0x17 },
    { 0x083A, 0x00 },
    { 0x083B, 0x17 },
    { 0x083C, 0x00 },
    { 0x083D, 0x77 },
    { 0x083E, 0x00 },
    { 0x083F, 0x17 },
    { 0x0842, 0x00 },
    { 0x0843, 0x0F },
    { 0x0844, 0x00 },
    { 0x0845, 0x37 },
    { 0x0847, 0x02 },
    /* Integration Time Setting */
    { 0x0202, 0x05 },
    { 0x0203, 0xEC },
    /* Gain Setting */
    { 0x0205, 0x00 },
    { 0x020E, 0x01 },
    { 0x020F, 0x00 },
    { 0x0210, 0x01 },
    { 0x0211, 0x00 },
    { 0x0212, 0x01 },
    { 0x0213, 0x00 },
    { 0x0214, 0x01 },
    { 0x0215, 0x00 },
    /* HDR Setting */
    { 0x0233, 0x00 },
    { 0x0234, 0x00 },
    { 0x0235, 0x40 },
    { 0x0238, 0x01 },
    { 0x0239, 0x08 },
    { 0x13C2, 0x00 },
    { 0x13C3, 0x00 },
    { 0x13C4, 0x00 },
    { 0xAD34, 0x14 },
    { 0xAD35, 0x7F },
    { 0xAD36, 0x00 },
    { 0xAD37, 0x00 },
    { 0xAD38, 0x0F },
    { 0xAD39, 0x5D },
    { 0xAD3A, 0x00 },
    { 0xAD3B, 0x00 },
    { 0xAD3C, 0x14 },
    { 0xAD3D, 0x7F },
    { 0xAD3E, 0x0F },
    { 0xAD3F, 0x5D },
    /* Bypass Setting */
    { 0xA303, 0x00 },
    { 0xA403, 0x00 },
    { 0xA602, 0x00 },
    { 0xA703, 0x01 },
    { 0xA903, 0x01 },
    { 0xA956, 0x01 },
    { 0xAA03, 0x01 },
    { 0xAB03, 0x00 },
    { 0xAC03, 0x01 },
    { 0xAD03, 0x01 },
    { 0xAE03, 0x01 },
    { 0xB803, 0x01 },
    { 0xB903, 0x01 },
    { 0xB91A, 0x01 },
    { 0xBB03, 0x00 },
    /* Single Correct setting */
    { 0x4003, 0x00 },
    { 0x4004, 0x00 },
    { 0x4005, 0x00 },
    { 0x4006, 0x80 },
    { 0x4007, 0x80 },
    { 0x4008, 0x80 },
    { 0x400C, 0x00 },
    { 0x400D, 0x00 },
    { 0x400E, 0x00 },
    { 0x400F, 0x80 },
    { 0x4010, 0x80 },
    { 0x4011, 0x80 },
    /* Mode etc setting */
    { 0x3008, 0x01 },
    { 0x3009, 0x51 },
    { 0x300A, 0x51 },
    { 0x3506, 0x00 },
    { 0x3507, 0x01 },
    { 0x3508, 0x00 },
    { 0x3509, 0x01 },
    { 0xA913, 0x00 },
    { 0xAC13, 0x00 },
    { 0xAC3F, 0x00 },
    { 0xAE8B, 0x29 },
    { 0xB812, 0x00 },
    /* LNR setting */
    { 0x3516, 0x00 },
    { 0x3517, 0x00 },
    { 0x3518, 0x00 },
    { 0x3519, 0x00 },
    { 0x351A, 0x00 },
    { 0x351B, 0x00 },
    { 0x351C, 0x00 },
    { 0x351D, 0x00 },
    { 0x351E, 0x00 },
    { 0x351F, 0x00 },
    { 0x3520, 0x00 },
    { 0x3521, 0x00 },
    { 0x3522, 0x00 },
};

static const struct cam_i2c_reg_array res_3600x2024_24fps_arrays[] = {
    /* 4K UHDish (16:9) @ 24 fps */
    /* 3600 x 2024 */
    /* Clock Setting */
    { 0x0301, 0x08 },
    { 0x0303, 0x01 },
    { 0x0304, 0x02 },
    { 0x0305, 0x06 },
    { 0x0306, 0x00 },
    { 0x0307, 0x31 },
    { 0x0309, 0x0A },
    { 0x030B, 0x01 },
    { 0x030C, 0x00 },
    { 0x030D, 0xAE },
    /* Size setting */
    { 0x0340, 0x08 },
    { 0x0341, 0x1A },
    { 0x0342, 0x17 },
    { 0x0343, 0x10 },
    { 0x0344, 0x03 },
    { 0x0345, 0x38 },
    { 0x0346, 0x03 },
    { 0x0347, 0xBC },
    { 0x0348, 0x11 },
    { 0x0349, 0x47 },
    { 0x034A, 0x0B },
    { 0x034B, 0xA3 },
    { 0x034C, 0x0E },
    { 0x034D, 0x10 },
    { 0x034E, 0x07 },
    { 0x034F, 0xE8 },
    { 0x0350, 0x00 },
    { 0x0351, 0x00 },
    { 0x0352, 0x00 },
    { 0x0353, 0x00 },
    { 0x0354, 0x0E },
    { 0x0355, 0x10 },
    { 0x0356, 0x07 },
    { 0x0357, 0xE8 },
    { 0x901D, 0x08 },
    /* Mode Setting */
    { 0x0108, 0x03 },
    { 0x0112, 0x0A },
    { 0x0113, 0x0A },
    { 0x0381, 0x01 },
    { 0x0383, 0x01 },
    { 0x0385, 0x01 },
    { 0x0387, 0x01 },
    { 0x0390, 0x00 },
    { 0x0391, 0x11 },
    { 0x0392, 0x00 },
    { 0x1307, 0x00 },
    { 0x9512, 0x40 },
    { 0xAB07, 0x01 },
    { 0xB802, 0x01 },
    { 0xB933, 0x00 },
    /* OptionnalFunction setting */
    { 0x0700, 0x00 },
    { 0x13C0, 0x01 },
    { 0x13C1, 0x02 },
    { 0x9909, 0x01 },
    { 0x991E, 0x01 },
    { 0xBA03, 0x00 },
    { 0xBA07, 0x00 },
    /* Global Timing Setting */
    { 0x0830, 0x00 },
    { 0x0831, 0x6F },
    { 0x0832, 0x00 },
    { 0x0833, 0x2F },
    { 0x0834, 0x00 },
    { 0x0835, 0x57 },
    { 0x0836, 0x00 },
    { 0x0837, 0x2F },
    { 0x0838, 0x00 },
    { 0x0839, 0x2F },
    { 0x083A, 0x00 },
    { 0x083B, 0x2F },
    { 0x083C, 0x00 },
    { 0x083D, 0xBF },
    { 0x083E, 0x00 },
    { 0x083F, 0x27 },
    { 0x0842, 0x00 },
    { 0x0843, 0x0F },
    { 0x0844, 0x00 },
    { 0x0845, 0x37 },
    { 0x0847, 0x02 },
    /* Integration Time Setting */
    { 0x0202, 0x08 },
    { 0x0203, 0x12 },
    /* Gain Setting */
    { 0x0205, 0x00 },
    { 0x020E, 0x01 },
    { 0x020F, 0x00 },
    { 0x0210, 0x01 },
    { 0x0211, 0x00 },
    { 0x0212, 0x01 },
    { 0x0213, 0x00 },
    { 0x0214, 0x01 },
    { 0x0215, 0x00 },
    /* HDR Setting */
    { 0x0233, 0x00 },
    { 0x0234, 0x00 },
    { 0x0235, 0x40 },
    { 0x0238, 0x01 },
    { 0x0239, 0x08 },
    { 0x13C2, 0x00 },
    { 0x13C3, 0x00 },
    { 0x13C4, 0x00 },
    { 0xAD34, 0x14 },
    { 0xAD35, 0x7F },
    { 0xAD36, 0x00 },
    { 0xAD37, 0x00 },
    { 0xAD38, 0x0F },
    { 0xAD39, 0x5D },
    { 0xAD3A, 0x00 },
    { 0xAD3B, 0x00 },
    { 0xAD3C, 0x14 },
    { 0xAD3D, 0x7F },
    { 0xAD3E, 0x0F },
    { 0xAD3F, 0x5D },
    /* Bypass Setting */
    { 0xA303, 0x00 },
    { 0xA403, 0x00 },
    { 0xA602, 0x00 },
    { 0xA703, 0x01 },
    { 0xA903, 0x01 },
    { 0xA956, 0x01 },
    { 0xAA03, 0x01 },
    { 0xAB03, 0x01 },
    { 0xAC03, 0x01 },
    { 0xAD03, 0x01 },
    { 0xAE03, 0x01 },
    { 0xB803, 0x00 },
    { 0xB903, 0x01 },
    { 0xB91A, 0x01 },
    { 0xBB03, 0x00 },
    /* Single Correct setting */
    { 0x4003, 0x00 },
    { 0x4004, 0x00 },
    { 0x4005, 0x00 },
    { 0x4006, 0x80 },
    { 0x4007, 0x80 },
    { 0x4008, 0x80 },
    { 0x400C, 0x00 },
    { 0x400D, 0x00 },
    { 0x400E, 0x00 },
    { 0x400F, 0x80 },
    { 0x4010, 0x80 },
    { 0x4011, 0x80 },
    /* Mode etc setting */
    { 0x3008, 0x01 },
    { 0x3009, 0x51 },
    { 0x300A, 0x51 },
    { 0x3506, 0x00 },
    { 0x3507, 0x01 },
    { 0x3508, 0x00 },
    { 0x3509, 0x01 },
    { 0xA913, 0x00 },
    { 0xAC13, 0x00 },
    { 0xAC3F, 0x00 },
    { 0xAE8B, 0x36 },
    { 0xB812, 0x00 },
    /* LNR setting */
    { 0x3516, 0x00 },
    { 0x3517, 0x00 },
    { 0x3518, 0x00 },
    { 0x3519, 0x00 },
    { 0x351A, 0x00 },
    { 0x351B, 0x00 },
    { 0x351C, 0x00 },
    { 0x351D, 0x00 },
    { 0x351E, 0x00 },
    { 0x351F, 0x00 },
    { 0x3520, 0x00 },
    { 0x3521, 0x00 },
    { 0x3522, 0x00 },
};

static const struct cam_i2c_reg_setting frmival_2624x1476_user_data = {
    .size = ARRAY_SIZE(res_2624x1476_30fps_array),
    .regs = res_2624x1476_30fps_array,
};

//frame rate for 2624x1476 BGGR10
static const struct camera_ext_frmival_node frmival_2624x1476[] = {
    {
        .numerator = 1,
        .denominator = 30,
        .user_data = &frmival_2624x1476_user_data,
    },
};

static const struct cam_i2c_reg_setting frmival_2624x1968_user_data = {
    .size = ARRAY_SIZE(res_2624x1968_24fps_arrray),
    .regs = res_2624x1968_24fps_arrray,
};

//frame rate for 2624x1968 BGGR10
static const struct camera_ext_frmival_node frmival_2624x1968[] = {
    {
        .numerator = 1,
        .denominator = 24,
        .user_data = &frmival_2624x1968_user_data,
    },
};

static const struct cam_i2c_reg_setting frmival_3600x2024_user_data = {
    .size = ARRAY_SIZE(res_3600x2024_24fps_arrays),
    .regs = res_3600x2024_24fps_arrays,
};

//frame rate for 3600x2024 BGGR10
static const struct camera_ext_frmival_node frmival_3600x2024[] = {

    {
        .numerator = 1,
        .denominator = 24,
        .user_data = &frmival_3600x2024_user_data,
    },
};

static const struct cam_i2c_reg_setting frmival_5248x3936_user_data = {
    .size = ARRAY_SIZE(res_5248x3936_12fps_array),
    .regs = res_5248x3936_12fps_array,
};

//frame rate for 5248x3936 BGGR10
static const struct camera_ext_frmival_node frmival_5248x3936[] = {
    {
        .numerator = 1,
        .denominator = 12,
        .user_data = &frmival_5248x3936_user_data,
    },
};

// frame sizes for BGGR10
static const struct camera_ext_frmsize_node imx220_cam_frmsizes[] = {
    {
        .width = 2624,
        .height = 1476,
        .num_frmivals = ARRAY_SIZE(frmival_2624x1476),
        .frmival_nodes = frmival_2624x1476,
    },

    {
        .width = 2624,
        .height = 1968,
        .num_frmivals = ARRAY_SIZE(frmival_2624x1968),
        .frmival_nodes = frmival_2624x1968,
    },

    {
        .width = 3600,
        .height = 2024,
        .num_frmivals = ARRAY_SIZE(frmival_3600x2024),
        .frmival_nodes = frmival_3600x2024,
    },

    {
        .width = 5248,
        .height = 3936,
        .num_frmivals = ARRAY_SIZE(frmival_5248x3936),
        .frmival_nodes = frmival_5248x3936,
    },
};

// format for camera input
static const struct camera_ext_format_node imx220_cam_formats[] = {
    {
        .name = "BGGR10",
        .fourcc = V4L2_PIX_FMT_SBGGR10,
        .depth = 10,
        .num_frmsizes = ARRAY_SIZE(imx220_cam_frmsizes),
        .frmsize_nodes = imx220_cam_frmsizes,
    },
};

// imx220 input
static const struct camera_ext_input_node imx220_inputs[] = {
    {
        .name = "csi-imx220",
        .type = CAM_EXT_INPUT_TYPE_CAMERA,
        .status = 0,
        .capabilities = CAMERA_EXT_STREAM_CAP_PREVIEW |
                        CAMERA_EXT_STREAM_CAP_VIDEO |
                        CAMERA_EXT_STREAM_CAP_SNAPSHOT,
        .num_formats = ARRAY_SIZE(imx220_cam_formats),
        .format_nodes = imx220_cam_formats,
    },
};

//root node
const struct camera_ext_format_db mhb_camera_format_db = {
    .num_inputs = ARRAY_SIZE(imx220_inputs),
    .input_nodes = imx220_inputs,
};

extern struct camera_ext_ctrl_db mhb_camera_ctrl_db;

struct mhb_cdsi_config mhb_camera_csi_config =
{
    .direction = 0,
    .mode = 0x01,            /* TSB_CDSI_MODE_CSI */

    .tx_num_lanes = 4,
    .rx_num_lanes = 0,       /* variable */
    .tx_bits_per_lane = 0,  /* variable */
    .rx_bits_per_lane = 0,  /* variable */

    .hs_rx_timeout = 0xffffffff,

    .framerate = 0, /* variable */

    .pll_frs = 0,
    .pll_prd = 0,
    .pll_fbd = 26,

    .width = 0,  /* variable */
    .height = 0, /* variable */
    .bpp = 0,    /* variable */

    .bta_enabled = 0,
    .continuous_clock = 0,
    .blank_packet_enabled = 0,
    .video_mode = 0,
    .color_bar_enabled = 0,
};

/* Device Ops */
int imx220_get_csi_config(struct device *dev,
                       void *config)
{
    const struct camera_ext_format_user_config *cfg = camera_ext_get_user_config();
    const struct camera_ext_frmival_node *ival;

    ival = get_current_frmival_node(&mhb_camera_format_db, cfg);
    if (ival == NULL) {
        CAM_ERR("Failed to get current frame interval\n");
        return -1;
    }

    mhb_camera_csi_config.rx_num_lanes = 4;
    mhb_camera_csi_config.framerate = roundf((float)(ival->denominator) /
                                             (float)(ival->numerator));
    mhb_camera_csi_config.tx_bits_per_lane = 500000000;
    mhb_camera_csi_config.rx_bits_per_lane = 500000000;

    *(struct mhb_cdsi_config **)config = &mhb_camera_csi_config;

    return 0;
}

int imx220_soc_enable(struct device *dev, uint8_t bootmode)
{
    gpio_direction_out(s_data.dvdd_en, 1);
    gpio_direction_out(s_data.areg_en, 1);
    usleep(CAMERA_POWER_DELAY_US);

    gpio_direction_out(s_data.rst_n, 1);

    usleep(CAMERA_POWER_DELAY_US);

    /* configure init registers */
    size_t num = ARRAY_SIZE(init_reg_array);
    int i;
    int ret;
    for (i = 0; i < num; i++) {
        ret = mhb_camera_i2c_write_reg1_16(CAMERA_SENSOR_I2C_ADDR,
                                        init_reg_array[i].reg_addr,
                                        init_reg_array[i].data);
        if (ret)
            break;
    }
    return ret;
}

int imx220_soc_disable(struct device *dev)
{
    gpio_direction_out(s_data.rst_n, 0);
    gpio_direction_out(s_data.dvdd_en, 0);
    gpio_direction_out(s_data.areg_en, 0);

    usleep(CAMERA_POWER_DELAY_US);

    return 0;
}

int imx220_stream_configure(struct device *dev)
{
    int i;
    int ret;
    const struct camera_ext_format_user_config *cfg = camera_ext_get_user_config();
    const struct camera_ext_frmival_node *ival;

    ival = get_current_frmival_node(&mhb_camera_format_db, cfg);
    if (ival == NULL) {
        CAM_ERR("Failed to get current frame interval\n");
        return -1;
    }


    const struct cam_i2c_reg_setting *udata = ival->user_data;
    if (udata == NULL) {
        CAM_ERR("Failed to get user data\n");
        return -1;
    }

    for (i = 0; i < udata->size; i++) {
        ret = mhb_camera_i2c_write_reg1_16(CAMERA_SENSOR_I2C_ADDR,
                                        udata->regs[i].reg_addr,
                                        udata->regs[i].data);
        if (ret)
            break;
    }

    return ret;
}

int imx220_stream_enable(struct device *dev)
{
    int ret = start_metadata_task();

    if (!ret) {
        ret = mhb_camera_i2c_write_reg1_16(CAMERA_SENSOR_I2C_ADDR, 0x0100, 0x01);
        if (ret)
            stop_metadata_task();
    }

    return ret;
}

int imx220_stream_disable(struct device *dev)
{
    stop_metadata_task();
    return mhb_camera_i2c_write_reg1_16(CAMERA_SENSOR_I2C_ADDR, 0x0100, 0x00);
}

static int _dev_probe(struct device *dev)
{
    struct device_resource *res;

    memset(&s_data, 0, sizeof(s_data));

    res = device_resource_get_by_name(dev, DEVICE_RESOURCE_TYPE_GPIO, "rst_n");
    if (!res) {
        CAM_ERR("failed to get rst_n gpio\n");
        return -ENODEV;
    }
    s_data.rst_n = res->start;

    res = device_resource_get_by_name(dev, DEVICE_RESOURCE_TYPE_GPIO, "dvdd_en");
    if (!res) {
        CAM_ERR("failed to get dvdd_en gpio\n");
        return -ENODEV;
    }
    s_data.dvdd_en = res->start;

    res = device_resource_get_by_name(dev, DEVICE_RESOURCE_TYPE_GPIO, "areg_en");
    if (!res) {
        CAM_ERR("failed to get areg_en gpio\n");
        return -ENODEV;
    }
    s_data.areg_en = res->start;

    res = device_resource_get_by_name(dev, DEVICE_RESOURCE_TYPE_GPIO, "spi_sel");
    if (!res) {
        CAM_ERR("failed to get spi_sel gpio\n");
        return -ENODEV;
    }
    s_data.spi_sel = res->start;

    gpio_direction_out(s_data.spi_sel, 0);
    gpio_direction_out(s_data.rst_n, 0);
    gpio_direction_out(s_data.dvdd_en, 0);
    gpio_direction_out(s_data.areg_en, 0);

    camera_ext_register_format_db(&mhb_camera_format_db);
    camera_ext_register_control_db(&mhb_camera_ctrl_db);
    init_metadata_task();

    return 0;
}

static struct device_mhb_camera_dev_type_ops mhb_camera_type_ops = {
    .soc_enable = imx220_soc_enable,
    .soc_disable = imx220_soc_disable,
    .stream_configure = imx220_stream_configure,
    .stream_enable = imx220_stream_enable,
    .stream_disable = imx220_stream_disable,
    .get_csi_config = imx220_get_csi_config,
};

static struct device_driver_ops imx220_driver_ops = {
    .probe    = _dev_probe,
    .type_ops = &mhb_camera_type_ops,
};

struct device_driver imx220_mhb_camera_driver = {
    .type = DEVICE_TYPE_MHB_CAMERA_HW,
    .name = "Sony",
    .desc = "IMX220 MHB Camera",
    .ops  = &imx220_driver_ops,
};
